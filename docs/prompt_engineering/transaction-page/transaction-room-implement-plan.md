# Transaction Room Implementation Roadmap

This document outlines the detailed steps to implement the Transaction Room feature. It expands on the initial high-level plan with specific technical details for the Database, Backend, and Frontend layers.

## User Review Required

> [!IMPORTANT] > **Database Trigger Strategy**:
>
> - For **Item #1 (Time-based Status Update)**: Database triggers strictly react to _events_. To handle automatic expiration, we will use **pg_cron** directly in the database.
>   - _Recommendation_: Use `pg_cron` to run a stored procedure every minute.
> - For **Item #2 (Auto-create Transaction)**: This _can_ be a standard Database Trigger. It will fire `AFTER UPDATE` on the `products` table when the status changes to `sold`.

## Phase 1: Database Layer

### 1.1. Create `Transactions` Table

We need a table to store the transaction state (if not already existing).

> [!IMPORTANT] > **Data Integrity**: We include an `amount` column to freeze the final auction price at the moment of transaction creation.

```sql
create table transactions (
  -- Auto-incrementing ID (PostgreSQL syntax)
  id integer generated by default as identity primary key,

  -- Foreign Keys
  product_id integer references products(id) on delete set null,
  buyer_id integer references users(id) on delete cascade,
  seller_id integer references users(id) on delete cascade,

  -- Basic Information
  final_price decimal(15, 2) not null,

  -- Order status (constrained to allowed values)
  status varchar(50) default 'payment_pending'
    check (status in ('payment_pending', 'shipping_pending', 'delivered', 'completed', 'cancelled')),

  -- STEP 1: Buyer Payment
  payment_proof_url text, -- Payment proof image link
  shipping_address text,  -- Shipping address

  -- STEP 2: Seller Confirmation & Shipping
  seller_confirmed_at timestamp with time zone, -- Timestamp when payment was confirmed by seller
  shipping_proof_url text, -- Shipping proof image link

  -- STEP 3: Buyer Receives Item
  buyer_received_at timestamp with time zone, -- Timestamp when buyer received the item

  -- STEP 4: Rating & Comment
  -- Rating can only be 1 (positive) or -1 (negative)
  buyer_rating integer check (buyer_rating in (1, -1)),
  buyer_comment text,

  seller_rating integer check (seller_rating in (1, -1)),
  seller_comment text,

  -- Metadata (Transaction creation and update times)
  created_at timestamp with time zone default now(),
  updated_at timestamp with time zone default now()
);
```

### 1.2. Implement "Auction Ender" Logic (Using pg_cron)

We will use the PostgreSQL extension `pg_cron` to close expired auctions automatically.

- **Step 1: Enable pg_cron Extension**
  ```sql
  CREATE EXTENSION IF NOT EXISTS pg_cron;
  ```
- **Step 2: Create Stored Procedure**
  This function checks for active auctions that have passed their end time and updates their status.

  ```sql
  CREATE OR REPLACE FUNCTION close_expired_auctions()
  RETURNS void AS $$
  BEGIN
      -- Option A: Mark as SOLD (if there is a bidder)
      UPDATE products
      SET status = 'sold'
      WHERE status = 'active'
        AND end_time <= NOW()
        AND highest_bidder_id IS NOT NULL;

      -- Option B: Mark as EXPIRED (if no bidder)
      UPDATE products
      SET status = 'expired'
      WHERE status = 'active'
        AND end_time <= NOW()
        AND highest_bidder_id IS NULL;
  END;
  $$ LANGUAGE plpgsql;
  ```

- **Step 3: Schedule the Job**
  Schedule the function to run every minute.
  ```sql
  SELECT cron.schedule('* * * * *', 'SELECT close_expired_auctions()');
  ```

### 1.3. Create Trigger for Transaction Creation (Item #2)

This trigger automatically creates a transaction row when a product is marked as `sold`.
**Update**: Now populates the `amount` from the product's `current_price`.

```sql
-- 1. Tạo Function xử lý
CREATE OR REPLACE FUNCTION create_transaction_on_sold()
RETURNS TRIGGER AS $$
BEGIN
    -- Kiểm tra: Nếu trạng thái sản phẩm chuyển sang 'sold'
    -- (và trạng thái cũ không phải là 'sold' để tránh duplicate)
    IF NEW.status = 'sold' AND (OLD.status IS DISTINCT FROM 'sold') THEN
        INSERT INTO transactions (
            product_id,
            buyer_id,
            seller_id,
            final_price, -- Đã sửa tên cột cho khớp với bảng mới (cũ là amount)
            status
        )
        VALUES (
            NEW.id,
            NEW.highest_bidder_id, -- Người thắng đấu giá
            NEW.seller_id,
            NEW.current_price,     -- Giá chốt hạ
            'payment_pending'      -- Trạng thái mặc định ban đầu
        );
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 2. Gắn Trigger vào bảng products
-- (Xoá trigger cũ trước nếu cần để tránh lỗi conflict)
DROP TRIGGER IF EXISTS trigger_create_transaction ON products;

CREATE TRIGGER trigger_create_transaction
AFTER UPDATE ON products
FOR EACH ROW
EXECUTE FUNCTION create_transaction_on_sold();
```

--- Phase 2: Update TransactionRoomPage UI

### 1. Component: `TransactionRoomPage` (Parent)

Đây là nơi điều phối logic chung.

- **Logic State:** Cần thêm hoặc giả lập biến `isSeller` (True/False) để điều khiển giao diện.
- **Actions:** Thay vì chỉ log ra console, cần chuẩn bị các hàm handler nhận File ảnh:
  - `handlePaymentProof(file)`: Dùng cho Bước 1.
  - `handleShippingProof(file)`: Dùng cho Bước 2.
  - `handleCancelTransaction()`: Dùng cho nút huỷ.

### 2. Component: `TransactionRoomPayment` (Bước 1)

Hiện tại đang là Form nhập địa chỉ (sai). Cần sửa lại thành **Giao diện Thanh toán & Xác thực**.

- **Phần hiển thị (Read-only):**
  - **Thông tin đơn hàng:** Tổng tiền phải trả.
  - **Thông tin chuyển khoản (QUAN TRỌNG):** Hiển thị rõ ràng Bank Info của Seller để Buyer chuyển tiền.
    - _UI:_ Một Card chứa: Tên ngân hàng, Số tài khoản, Chủ tài khoản, Nội dung chuyển khoản (Ví dụ: `MÃ_ĐƠN_HÀNG`).
- **Phần thao tác (Action):**
  - **Input Upload:** Một vùng (Dropzone) hoặc nút để upload ảnh "Biên lai chuyển khoản" (`payment_proof`).
  - **Nút xác nhận:** Đổi text thành **"Confirm Payment Sent"** (Chỉ enable khi đã chọn ảnh).

### 3. Component: `TransactionRoomShipping` (Bước 2)

Hiện tại đang tĩnh (sai). Cần chia làm 2 màn hình dựa vào biến `isSeller`.

- **Trường hợp User là Seller:**
  - _Thông báo:_ "Buyer đã thanh toán. Vui lòng kiểm tra tài khoản ngân hàng."
  - _Action 1:_ Nút/Input để nhập **Mã vận đơn** (Tracking Number) - _Optional nhưng nên có_.
  - _Action 2:_ Input Upload ảnh phiếu gửi hàng (`shipping_proof`).
  - _Nút xác nhận:_ **"Confirm Shipped"**. Hành động này sẽ chuyển trạng thái đơn sang `Delivering`.
- **Trường hợp User là Buyer:**
  - _Trạng thái:_ Hiển thị màn hình chờ (Waiting State).
  - _UI:_ Icon đồng hồ hoặc gói hàng đang chạy.
  - _Text:_ "Waiting for seller to confirm payment and ship the item..." (Đang chờ người bán kiểm tra tiền và gửi hàng).
  - _Action:_ Không có hành động nào cả (Disable mọi nút).

### 4. Component: `TransactionRoomHeader` (Header)

- **Thêm nút Huỷ (Cancel):**
  - _Vị trí:_ Góc phải, cạnh nút Rate.
  - _Điều kiện hiển thị:_ Chỉ hiện khi `isSeller === true` VÀ `status !== 'completed'`.
  - _Style:_ Màu đỏ (Destructive) để cảnh báo.
  - _Logic:_ Bấm vào -> Hiện Modal xác nhận "Bạn có chắc muốn huỷ kèo và đánh giá -1 cho người mua không?" -> Confirm -> Gọi API Cancel.

### 5. Component: `TransactionChat` & System Messages

Sửa lại nội dung text (Wording) để không gây hiểu nhầm:

- **Loại bỏ từ khoá:** Xoá sạch các từ liên quan đến **"Escrow"** (Giữ tiền hộ), "Funds secured".
- **Sửa tin nhắn hệ thống (System Message):**
  - _Bước 1 xong:_ Thay vì "Escrow secured...", sửa thành: **"Buyer has submitted payment proof. Waiting for Seller verification."**
  - _Bước 2 xong:_ Thay vì "Label created...", sửa thành: **"Seller confirmed payment & shipped the package."**

### Tóm tắt Checklist UI cần sửa:

1.  [ ] **Payment Step:** Thêm Bank Info Card + Upload Button. Bỏ form địa chỉ (hoặc cho xuống phụ).
2.  [ ] **Shipping Step (Seller):** Thêm Upload Form cho vận đơn.
3.  [ ] **Shipping Step (Buyer):** Làm màn hình "Waiting".
4.  [ ] **Header:** Thêm nút Cancel màu đỏ cho Seller.
5.  [ ] **Text:** Find & Replace chữ "Escrow" bằng "Direct Transfer" hoặc xoá hẳn.

---