generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model auto_bids {
  auto_bid_id Int      @id @default(autoincrement())
  product_id  Int
  bidder_id   Int
  max_amount  Decimal  @db.Decimal(15, 2)
  created_at  DateTime @default(now()) @db.Timestamp(6)
  users       users    @relation(fields: [bidder_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products    products @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([product_id, bidder_id])
  @@index([product_id, created_at], map: "idx_autobids_product_time")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model bids {
  bid_id     Int      @id @default(autoincrement())
  product_id Int
  bidder_id  Int
  amount     Decimal  @db.Decimal(15, 2)
  is_auto    Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamp(6)
  users      users    @relation(fields: [bidder_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products   products @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([bidder_id], map: "idx_bids_bidder")
  @@index([product_id, created_at(sort: Desc)], map: "idx_bids_product_time")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model categories {
  category_id      Int          @id @default(autoincrement())
  name             String       @db.VarChar(255)
  slug             String       @db.VarChar(255)
  parent_id        Int?
  categories       categories?  @relation("categoriesTocategories", fields: [parent_id], references: [category_id], onDelete: Restrict, onUpdate: NoAction)
  other_categories categories[] @relation("categoriesTocategories")
  products         products[]

  @@unique([parent_id, slug])
}

model invoices {
  invoice_id             Int       @id @default(autoincrement())
  order_id               Int       @unique
  shipping_address       String?
  payment_proof_url      String?   @db.VarChar(500)
  shipping_tracking_code String?   @db.VarChar(100)
  created_at             DateTime  @default(now()) @db.Timestamp(6)
  updated_at             DateTime? @db.Timestamp(6)
  orders                 orders    @relation(fields: [order_id], references: [order_id], onDelete: Cascade, onUpdate: NoAction)
}

model notifications {
  notification_id Int                       @id @default(autoincrement())
  user_id         Int
  type            String                    @db.VarChar(50)
  channel         notification_channel_enum @default(in_app)
  content         String
  is_read         Boolean                   @default(false)
  read_at         DateTime?                 @db.Timestamp(6)
  action_url      String?                   @db.VarChar(500)
  created_at      DateTime                  @default(now()) @db.Timestamp(6)
  users           users                     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, is_read, created_at(sort: Desc)], map: "idx_notifications_user_unread")
}

model order_chat {
  message_id                          Int      @id @default(autoincrement())
  order_id                            Int
  sender_id                           Int
  receiver_id                         Int
  content                             String
  created_at                          DateTime @default(now()) @db.Timestamp(6)
  orders                              orders   @relation(fields: [order_id], references: [order_id], onDelete: Cascade, onUpdate: NoAction)
  users_order_chat_receiver_idTousers users    @relation("order_chat_receiver_idTousers", fields: [receiver_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_order_chat_sender_idTousers   users    @relation("order_chat_sender_idTousers", fields: [sender_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([order_id, created_at], map: "idx_chat_order")
}

model orders {
  order_id                      Int               @id @default(autoincrement())
  product_id                    Int               @unique
  winner_id                     Int
  seller_id                     Int
  final_price                   Decimal           @db.Decimal(15, 2)
  status                        order_status_enum @default(pending)
  cancellation_reason           String?
  created_at                    DateTime          @default(now()) @db.Timestamp(6)
  invoices                      invoices?
  order_chat                    order_chat[]
  products                      products          @relation(fields: [product_id], references: [product_id], onUpdate: NoAction)
  users_orders_seller_idTousers users             @relation("orders_seller_idTousers", fields: [seller_id], references: [id], onUpdate: NoAction)
  users_orders_winner_idTousers users             @relation("orders_winner_idTousers", fields: [winner_id], references: [id], onUpdate: NoAction)
  reviews                       reviews[]
}

model permissions {
  permission_id     Int                 @id @default(autoincrement())
  name              String              @unique @db.VarChar(100)
  roles_permissions roles_permissions[]
}

model product_comments {
  comment_id             Int                @id @default(autoincrement())
  product_id             Int
  user_id                Int
  content                String
  parent_id              Int?
  created_at             DateTime           @default(now()) @db.Timestamp(6)
  updated_at             DateTime?          @db.Timestamp(6)
  product_comments       product_comments?  @relation("product_commentsToproduct_comments", fields: [parent_id], references: [comment_id], onDelete: Cascade, onUpdate: NoAction)
  other_product_comments product_comments[] @relation("product_commentsToproduct_comments")
  products               products           @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)
  users                  users              @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([parent_id], map: "idx_comments_parent")
  @@index([product_id, created_at], map: "idx_comments_product")
}

model product_descriptions {
  description_id Int      @id @default(autoincrement())
  product_id     Int
  author_id      Int
  content        String
  lang           String   @default("vi") @db.VarChar(10)
  version        Int      @default(1)
  created_at     DateTime @default(now()) @db.Timestamp(6)
  users          users    @relation(fields: [author_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products       products @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([product_id, version])
}

model product_images {
  image_id   Int      @id @default(autoincrement())
  product_id Int
  image_url  String   @db.VarChar(500)
  products   products @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)
}

model product_rejections {
  rejection_id Int      @id @default(autoincrement())
  product_id   Int
  bidder_id    Int
  reason       String?
  created_at   DateTime @default(now()) @db.Timestamp(6)
  users        users    @relation(fields: [bidder_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products     products @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([product_id, bidder_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model products {
  product_id                              Int                      @id @default(autoincrement())
  category_id                             Int
  seller_id                               Int
  highest_bidder_id                       Int?
  name                                    String                   @db.VarChar(500)
  thumbnail_url                           String?                  @db.VarChar(500)
  current_price                           Decimal                  @db.Decimal(15, 2)
  buy_now_price                           Decimal?                 @db.Decimal(15, 2)
  start_price                             Decimal                  @db.Decimal(15, 2)
  step_price                              Decimal                  @db.Decimal(15, 2)
  start_time                              DateTime                 @default(now()) @db.Timestamp(6)
  end_time                                DateTime                 @db.Timestamp(6)
  bid_count                               Int                      @default(0)
  auto_extend                             Boolean                  @default(false)
  status                                  product_status_enum      @default(active)
  fts                                     Unsupported("tsvector")?
  created_at                              DateTime                 @default(now()) @db.Timestamp(6)
  auto_bids                               auto_bids[]
  bids                                    bids[]
  orders                                  orders?
  product_comments                        product_comments[]
  product_descriptions                    product_descriptions[]
  product_images                          product_images[]
  product_rejections                      product_rejections[]
  categories                              categories               @relation(fields: [category_id], references: [category_id], onUpdate: NoAction)
  users_products_highest_bidder_idTousers users?                   @relation("products_highest_bidder_idTousers", fields: [highest_bidder_id], references: [id], onUpdate: NoAction)
  users_products_seller_idTousers         users                    @relation("products_seller_idTousers", fields: [seller_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  watchlist                               watchlist[]

  @@index([category_id, status], map: "idx_products_category_status")
  @@index([fts], map: "idx_products_fts", type: Gin)
  @@index([status, end_time], map: "idx_products_status_endtime")
}

model refresh_tokens {
  token_id     Int       @id @default(autoincrement())
  user_id      Int
  token_hash   String    @unique @db.VarChar(255)
  expires_at   DateTime  @db.Timestamp(6)
  device_info  String?
  ip_address   String?   @db.VarChar(45)
  created_at   DateTime  @default(now()) @db.Timestamp(6)
  last_used_at DateTime? @db.Timestamp(6)
  users        users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_refresh_tokens_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model reviews {
  review_id                          Int       @id @default(autoincrement())
  order_id                           Int
  reviewer_id                        Int
  reviewered_id                      Int
  rating                             Int
  content                            String?
  created_at                         DateTime  @default(now()) @db.Timestamp(6)
  updated_at                         DateTime? @db.Timestamp(6)
  orders                             orders    @relation(fields: [order_id], references: [order_id], onDelete: Cascade, onUpdate: NoAction)
  users_reviews_reviewer_idTousers   users     @relation("reviews_reviewer_idTousers", fields: [reviewer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users_reviews_reviewered_idTousers users     @relation("reviews_reviewered_idTousers", fields: [reviewered_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([order_id, reviewer_id, reviewered_id])
}

model roles {
  role_id           Int                 @id @default(autoincrement())
  name              String              @unique @db.VarChar(50)
  roles_permissions roles_permissions[]
  users_roles       users_roles[]
}

model roles_permissions {
  role_id       Int
  permission_id Int
  permissions   permissions @relation(fields: [permission_id], references: [permission_id], onDelete: Cascade, onUpdate: NoAction)
  roles         roles       @relation(fields: [role_id], references: [role_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([role_id, permission_id])
}

model system_settings {
  setting_key   String   @id @db.VarChar(50)
  setting_value String   @db.VarChar(255)
  description   String?
  updated_at    DateTime @default(now()) @db.Timestamp(6)
}

model upgrade_requests {
  request_id  Int                 @id @default(autoincrement())
  user_id     Int
  status      upgrade_status_enum @default(pending)
  created_at  DateTime            @default(now()) @db.Timestamp(6)
  approved_at DateTime?           @db.Timestamp(6)
  expires_at  DateTime?           @default(dbgenerated("(CURRENT_TIMESTAMP + '7 days'::interval)")) @db.Timestamp(6)
  users       users               @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model user_otps {
  otp_id      Int              @id @default(autoincrement())
  user_id     Int
  otp_code    String           @db.VarChar(10)
  purpose     otp_purpose_enum
  created_at  DateTime         @default(now()) @db.Timestamp(6)
  expires_at  DateTime         @db.Timestamp(6)
  consumed_at DateTime?        @db.Timestamp(6)
  users       users            @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model users {
  id                                         Int                         @id @default(autoincrement())
  full_name                                  String                      @db.VarChar(255)
  email                                      String                      @unique @db.VarChar(255)
  password                                   String                      @db.VarChar(255)
  address                                    String?                     @db.VarChar(500)
  is_verified                                Boolean                     @default(false)
  positive_reviews                           Int                         @default(0)
  negative_reviews                           Int                         @default(0)
  status                                     user_status_enum            @default(pending_verification)
  password_updated_at                        DateTime?                   @db.Timestamp(6)
  failed_login_attempts                      Int                         @default(0)
  last_login_at                              DateTime?                   @db.Timestamp(6)
  created_at                                 DateTime                    @default(now()) @db.Timestamp(6)
  updated_at                                 DateTime                    @default(now()) @db.Timestamp(6)
  auto_bids                                  auto_bids[]
  bids                                       bids[]
  conversation_participants                  conversation_participants[]
  conversations                              conversations[]
  messages                                   messages[]
  notifications                              notifications[]
  order_chat_order_chat_receiver_idTousers   order_chat[]                @relation("order_chat_receiver_idTousers")
  order_chat_order_chat_sender_idTousers     order_chat[]                @relation("order_chat_sender_idTousers")
  orders_orders_seller_idTousers             orders[]                    @relation("orders_seller_idTousers")
  orders_orders_winner_idTousers             orders[]                    @relation("orders_winner_idTousers")
  otp_verifications                          otp_verifications[]
  product_comments                           product_comments[]
  product_descriptions                       product_descriptions[]
  product_rejections                         product_rejections[]
  products_products_highest_bidder_idTousers products[]                  @relation("products_highest_bidder_idTousers")
  products_products_seller_idTousers         products[]                  @relation("products_seller_idTousers")
  refresh_tokens                             refresh_tokens[]
  reviews_reviews_reviewer_idTousers         reviews[]                   @relation("reviews_reviewer_idTousers")
  reviews_reviews_reviewered_idTousers       reviews[]                   @relation("reviews_reviewered_idTousers")
  upgrade_requests                           upgrade_requests[]
  user_otps                                  user_otps[]
  users_roles                                users_roles[]
  watchlist                                  watchlist[]
}

model users_roles {
  user_id Int
  role_id Int
  roles   roles @relation(fields: [role_id], references: [role_id], onDelete: Cascade, onUpdate: NoAction)
  users   users @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, role_id])
}

model watchlist {
  user_id    Int
  product_id Int
  created_at DateTime @default(now()) @db.Timestamp(6)
  products   products @relation(fields: [product_id], references: [product_id], onDelete: Cascade, onUpdate: NoAction)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, product_id])
}

model conversation_participants {
  user_id         Int
  conversation_id Int
  joined_at       DateTime?     @default(now()) @db.Timestamp(6)
  conversations   conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users           users         @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, conversation_id])
}

model conversations {
  id                        Int                         @id @default(autoincrement())
  name                      String?                     @db.VarChar(255)
  is_group                  Boolean?                    @default(false)
  creator_id                Int
  created_at                DateTime?                   @default(now()) @db.Timestamp(6)
  conversation_participants conversation_participants[]
  users                     users                       @relation(fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  messages                  messages[]
}

model messages {
  id              Int           @id @default(autoincrement())
  conversation_id Int
  sender_id       Int
  body            String
  created_at      DateTime?     @default(now()) @db.Timestamp(6)
  conversations   conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users           users         @relation(fields: [sender_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversation_id], map: "idx_messages_conversation")
  @@index([created_at], map: "idx_messages_created")
  @@index([sender_id], map: "idx_messages_sender")
}

model otp_verifications {
  id         Int       @id @default(autoincrement())
  user_id    Int
  otp        String    @db.VarChar(6)
  is_used    Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at], map: "idx_otp_created_at")
  @@index([is_used], map: "idx_otp_is_used")
  @@index([user_id], map: "idx_otp_user_id")
}

enum notification_channel_enum {
  email
  in_app
}

enum order_status_enum {
  pending
  payment_confirmed
  shipped
  completed
  cancelled
}

enum otp_purpose_enum {
  signup
  reset_password
  other
}

enum product_status_enum {
  active
  sold
  expired
  removed
}

enum upgrade_status_enum {
  pending
  approved
  rejected
  expired
  cancelled
}

enum user_status_enum {
  pending_verification
  active
  pending_upgrade
  suspended
}
